<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Triangle Grid Image Toggle with Save</title>
<style>
  canvas {
    border: 0px solid #333;
    display: block;
  }
</style>
</head>
<body>

<canvas id="triangleGrid" width="1200" height="800"></canvas>
<button id="saveBtn">Cleanup and Name</button>

<script>
const canvas = document.getElementById('triangleGrid');
const ctx = canvas.getContext('2d');

const cols = 6;
const rows = 4;
const triSize = 200;
const triHeight = triSize * Math.sqrt(3) / 2;

// Image sources (served from a local server, not C:/ directly)
const imageSources = [
  'https://mourdos.github.io/LightsOut10x10/Alchemy/UpEmpty.png',
  'https://mourdos.github.io/LightsOut10x10/Alchemy/UpFilled.png',
  'https://mourdos.github.io/LightsOut10x10/Alchemy/UpStart.png',
  'https://mourdos.github.io/LightsOut10x10/Alchemy/UpEnd.png'
];
const otherimageSources = [
  'https://mourdos.github.io/LightsOut10x10/Alchemy/DownEmpty.png',
  'https://mourdos.github.io/LightsOut10x10/Alchemy/DownFilled.png',
  'https://mourdos.github.io/LightsOut10x10/Alchemy/DownStart.png',
  'https://mourdos.github.io/LightsOut10x10/Alchemy/DownEnd.png'

];

const otherimages = [];
let otherimagesLoaded = 0;
const images = [];
let imagesLoaded = 0;

// Preload images
imageSources.forEach(src => {
  const img = new Image();
  img.src = src;
  img.onload = () => {
    imagesLoaded++;
    if (imagesLoaded === imageSources.length) {
      createGrid();
      drawGrid();
    }
  };
  images.push(img);
});

// Preload images
otherimageSources.forEach(src => {
  const img = new Image();
  img.src = src;
  img.onload = () => {
    otherimagesLoaded++;
    if (otherimagesLoaded === otherimageSources.length) {
      createGrid();
      drawGrid();
    }
  };
  otherimages.push(img);
});

const triangles = [];

function createGrid() {
  for (let row = 0; row < rows; row++) {
    for (let col = 0; col < cols; col++) {
      const x = col * triSize * 0.499;
      const y = row * triHeight * 0.999;
      const pointingUp = (row + col) % 2 === 0;

      triangles.push({
        x,
        y,
        pointingUp,
        imageIndex: 0
      });
    }
  }
}



function drawTriangle(tri) {
  const img = images[tri.imageIndex];
  const oimg = otherimages[tri.imageIndex]
  ctx.save();

  ctx.translate(tri.x + triSize / 2, tri.y + triHeight / 2); // center of the triangle area

  if (tri.pointingUp) {
      // Draw the image stretched to fit triangle width and correct height
    ctx.drawImage(img, 
    -triSize / 2, 
    -triHeight / 2, 
    triSize, 
    triHeight);

  } else {
    // Draw the image stretched to fit triangle width and correct height
    ctx.drawImage(oimg, 
    -triSize / 2, 
    -triHeight / 2, 
    triSize, 
    triHeight);
  }

  ctx.restore();

}

function drawGrid(hideIndexZero = false) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  triangles.forEach(tri => {
    // If hiding index 0 during PNG save, skip drawing this triangle
    if (hideIndexZero && tri.imageIndex === 0) return;
    drawTriangle(tri);
  });
}

function pointInTriangle(px, py, ax, ay, bx, by, cx, cy) {
  const v0x = cx - ax, v0y = cy - ay;
  const v1x = bx - ax, v1y = by - ay;
  const v2x = px - ax, v2y = py - ay;

  const dot00 = v0x * v0x + v0y * v0y;
  const dot01 = v0x * v1x + v0y * v1y;
  const dot02 = v0x * v2x + v0y * v2y;
  const dot11 = v1x * v1x + v1y * v1y;
  const dot12 = v1x * v2x + v1y * v2y;

  const invDenom = 1 / (dot00 * dot11 - dot01 * dot01);
  const u = (dot11 * dot02 - dot01 * dot12) * invDenom;
  const v = (dot00 * dot12 - dot01 * dot02) * invDenom;

  return (u >= 0) && (v >= 0) && (u + v <= 1);
}

canvas.addEventListener('click', e => {
  const rect = canvas.getBoundingClientRect();
  const clickX = e.clientX - rect.left;
  const clickY = e.clientY - rect.top;

  for (const tri of triangles) {
    let ax, ay, bx, by, cx, cy;
    if (tri.pointingUp) {
      ax = tri.x;
      ay = tri.y + triHeight;
      bx = tri.x + triSize / 2;
      by = tri.y;
      cx = tri.x + triSize;
      cy = tri.y + triHeight;
    } else {
      ax = tri.x;
      ay = tri.y;
      bx = tri.x + triSize / 2;
      by = tri.y + triHeight;
      cx = tri.x + triSize;
      cy = tri.y;
    }

    if (pointInTriangle(clickX, clickY, ax, ay, bx, by, cx, cy)) {
      tri.imageIndex = (tri.imageIndex + 1) % images.length;
      drawGrid();
      break;
    }
  }
});

document.getElementById('saveBtn').addEventListener('click', () => {
  const userText = prompt("Enter the text to add to the image:", "Generated by LightsOut10x10");
  if (userText === null) return;

  const fileName = userText.trim();

  drawGrid(false);

  ctx.font = "24px Arial";
  ctx.fillStyle = "black";
  ctx.textAlign = "center";
  ctx.fillText(userText, canvas.width / 2, canvas.height - 10);

  // Convert canvas to image
  const imageURL = canvas.toDataURL("image/png");
  const img = new Image();
  img.src = imageURL;

  // Optionally set image style to match canvas size
  img.width = canvas.width;
  img.height = canvas.height;

  // Replace canvas with the new image
  canvas.parentNode.replaceChild(img, canvas);

  // Optional: provide a download link
  const link = document.createElement('a');
  link.download = fileName + '.png';
  link.href = imageURL;
  link.textContent = "Download " + fileName + ".png";
  document.body.appendChild(link);

  alert("Canvas replaced with image and ready to right-click/save as!");
});

</script>

</body>
</html>
